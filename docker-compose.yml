services:
  redis:
    image: valkey/valkey:8
    container_name: valkey
    ports:
      - "6379:6379"
    volumes:
      - valkey_data:/data
    restart: unless-stopped

  tinirun:
    build:
      context: .
    ports:
      - "8080:8080"
    depends_on:
      - redis
    user: "${RUNNER_UID-10001}:${RUNNER_GID-1000}"
    privileged: true
    environment:
      - RUNNER_REDIS_URL=redis://redis:6379
      - RUNNER_API_KEY=api-key-123
      - RUNNER_LOG_LEVEL=info
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock

  demo:
    build:
      context: .
      dockerfile: demo/Dockerfile
    ports:
      - "3000:3000"
    depends_on:
      - tinirun
    environment:
      - DEMO_TINIRUN_URL=http://tinirun:8080/api
      - DEMO_TINIRUN_API_KEY=api-key-123

volumes:
  valkey_data:
